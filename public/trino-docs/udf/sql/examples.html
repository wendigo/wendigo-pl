


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../sql.html">
      
      
        <link rel="next" href="begin.html">
      
      
      <link rel="icon" href="">
    
    
      
        <title>Example SQL UDFs - Trino 476-SNAPSHOT Documentation</title>
      
    
    
      
        
      
      


    
    
      
    
    
      
        
        
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
        <link rel="stylesheet" type="text/css" href="../../_static/sphinx_immaterial_theme.96fe8683ff2bd71e9.min.css?v=13adf062" />
        <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
        <link rel="stylesheet" type="text/css" href="../../_static/trino.css?v=c5cc3cca" />
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../index.html" title="Trino 476-SNAPSHOT Documentation" class="md-header__button md-logo" aria-label="Trino 476-SNAPSHOT Documentation" data-md-component="logo">
      <img src="../../_static/trino.svg" alt="logo">
    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Trino 476-SNAPSHOT Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Example SQL UDFs
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/trinodb/trino" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
  </div>
  <div class="md-source__repository">
    Trino
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../index.html" title="Trino 476-SNAPSHOT Documentation" class="md-nav__button md-logo" aria-label="Trino 476-SNAPSHOT Documentation" data-md-component="logo">
      <img src="../../_static/trino.svg" alt="logo">
    </a>
    Trino 476-SNAPSHOT Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/trinodb/trino" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
  </div>
  <div class="md-source__repository">
    Trino
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../client.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Clients
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../admin.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Administration
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Query optimizer
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../connector.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Connectors
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../object-storage.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Object storage
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Functions and operators
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../udf.html" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    User-<wbr>defined functions
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_10" id="__nav_10_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            User-<wbr>defined functions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../introduction.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction to UDFs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../function.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FUNCTION
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_3" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../sql.html" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    SQL user-<wbr>defined functions
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_10_3" id="__nav_10_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10_3">
            <span class="md-nav__icon md-icon"></span>
            SQL user-<wbr>defined functions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      <a href="#" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Example SQL UDFs
    
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
  
    <li class="md-nav__item">
      <a href="begin.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    BEGIN
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
  
    <li class="md-nav__item">
      <a href="case.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CASE
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
  
    <li class="md-nav__item">
      <a href="declare.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DECLARE
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
  
    <li class="md-nav__item">
      <a href="if.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    IF
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
  
    <li class="md-nav__item">
      <a href="iterate.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ITERATE
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
  
    <li class="md-nav__item">
      <a href="leave.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LEAVE
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
  
    <li class="md-nav__item">
      <a href="loop.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LOOP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
  
    <li class="md-nav__item">
      <a href="repeat.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    REPEAT
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
  
    <li class="md-nav__item">
      <a href="return.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RETURN
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
  
    <li class="md-nav__item">
      <a href="set.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SET
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
  
    <li class="md-nav__item">
      <a href="while.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WHILE
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  
  

              
            
              
                
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../python.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Python user-<wbr>defined functions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../language.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SQL language
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SQL statement syntax
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../develop.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Developer guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../glossary.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Glossary
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../appendix.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Appendix
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../release.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Release notes
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset" role="main">
                
                
                  


<h1 id="example-sql-udfs">Example SQL UDFs<a class="headerlink" href="#example-sql-udfs" title="Link to this heading">#</a></h1>
<p>After learning about <a class="reference internal" href="../sql.html"><span class="doc std std-doc">SQL user-defined functions</span></a>, the following sections show numerous examples
of valid SQL UDFs. The UDFs are suitable as <a class="reference internal" href="../introduction.html#udf-inline"><span class="std std-ref">Inline user-defined functions</span></a> or <a class="reference internal" href="../introduction.html#udf-catalog"><span class="std std-ref">Catalog user-defined functions</span></a>,
after adjusting the name and the example invocations.</p>
<p>The examples combine numerous supported statements. Refer to the specific
statement documentation for further details:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../function.html"><span class="doc std std-doc">FUNCTION</span></a> for general UDF declaration</p></li>
<li><p><a class="reference internal" href="begin.html"><span class="doc std std-doc">BEGIN</span></a> and <a class="reference internal" href="declare.html"><span class="doc std std-doc">DECLARE</span></a> for SQL UDF blocks</p></li>
<li><p><a class="reference internal" href="set.html"><span class="doc std std-doc">SET</span></a> for assigning values to variables</p></li>
<li><p><a class="reference internal" href="return.html"><span class="doc std std-doc">RETURN</span></a> for returning results</p></li>
<li><p><a class="reference internal" href="case.html"><span class="doc std std-doc">CASE</span></a> and <a class="reference internal" href="if.html"><span class="doc std std-doc">IF</span></a> for conditional flows</p></li>
<li><p><a class="reference internal" href="loop.html"><span class="doc std std-doc">LOOP</span></a>, <a class="reference internal" href="repeat.html"><span class="doc std std-doc">REPEAT</span></a>, and <a class="reference internal" href="while.html"><span class="doc std std-doc">WHILE</span></a> for looping constructs</p></li>
<li><p><a class="reference internal" href="iterate.html"><span class="doc std std-doc">ITERATE</span></a> and <a class="reference internal" href="leave.html"><span class="doc std std-doc">LEAVE</span></a> for flow control</p></li>
</ul>
<h2 id="inline-and-catalog-udfs">Inline and catalog UDFs<a class="headerlink" href="#inline-and-catalog-udfs" title="Link to this heading">#</a></h2>
<p>The following section shows the differences in usage with inline and catalog
UDFs with a simple SQL UDF example. The same pattern applies to all other
following sections.</p>
<p>A very simple SQL UDF that returns a static value without requiring any input:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">answer</span><span class="p">()</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">BIGINT</span>
<span class="k">RETURN</span><span class="w"> </span><span class="mi">42</span>
</code></pre></div>
</div>
<p>A full example of this UDF as inline UDF and usage in a string concatenation
with a cast:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">WITH</span>
<span class="w">  </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">answer</span><span class="p">()</span>
<span class="w">  </span><span class="k">RETURNS</span><span class="w"> </span><span class="nb">BIGINT</span>
<span class="w">  </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">42</span>
<span class="k">SELECT</span><span class="w"> </span><span class="s1">&#39;The answer is &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">answer</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">varchar</span><span class="p">);</span>
<span class="c1">-- The answer is 42</span>
</code></pre></div>
</div>
<p>Provided the catalog <code class="docutils literal notranslate"><span class="pre">example</span></code> supports UDF storage in the <code class="docutils literal notranslate"><span class="pre">default</span></code> schema, you
can use the following:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">example</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">answer</span><span class="p">()</span>
<span class="w">  </span><span class="k">RETURNS</span><span class="w"> </span><span class="nb">BIGINT</span>
<span class="w">  </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span>
</code></pre></div>
</div>
<p>With the UDF stored in the catalog, you can run the UDF multiple times without
repeated definition:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">example</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">answer</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">-- 43</span>
<span class="k">SELECT</span><span class="w"> </span><span class="s1">&#39;The answer is &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">example</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">answer</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">varchar</span><span class="p">);</span><span class="w"> </span><span class="c1">-- The answer is 42</span>
</code></pre></div>
</div>
<p>Alternatively, you can configure the SQL PATH in the <a class="reference internal" href="../../installation/deployment.html#config-properties"><span class="std std-ref">Config properties</span></a> to a
catalog and schema that support UDF storage:</p>
<div class="highlight-properties notranslate"><div class="highlight"><pre><span></span><code><span class="na">sql.default-function-catalog</span><span class="o">=</span><span class="s">example</span>
<span class="na">sql.default-function-schema</span><span class="o">=</span><span class="s">default</span>
<span class="na">sql.path</span><span class="o">=</span><span class="s">example.default</span>
</code></pre></div>
</div>
<p>Now you can manage UDFs without the full path:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">answer</span><span class="p">()</span>
<span class="w">  </span><span class="k">RETURNS</span><span class="w"> </span><span class="nb">BIGINT</span>
<span class="w">  </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span>
</code></pre></div>
</div>
<p>UDF invocation works without the full path:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">answer</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="c1">-- 47</span>
</code></pre></div>
</div>
<h2 id="declaration-examples">Declaration examples<a class="headerlink" href="#declaration-examples" title="Link to this heading">#</a></h2>
<p>The result of calling the UDF <code class="docutils literal notranslate"><span class="pre">answer()</span></code> is always identical, so you can
declare it as deterministic, and add some other information:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">answer</span><span class="p">()</span>
<span class="k">LANGUAGE</span><span class="w"> </span><span class="k">SQL</span>
<span class="k">DETERMINISTIC</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">BIGINT</span>
<span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;Provide the answer to the question about life, the universe, and everything.&#39;</span>
<span class="k">RETURN</span><span class="w"> </span><span class="mi">42</span>
</code></pre></div>
</div>
<p>The comment and other information about the UDF is visible in the output of
<a class="reference internal" href="../../sql/show-functions.html"><span class="doc std std-doc">SHOW FUNCTIONS</span></a>.</p>
<p>A simple UDF that returns a greeting back to the input string <code class="docutils literal notranslate"><span class="pre">fullname</span></code>
concatenating two strings and the input value:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">hello</span><span class="p">(</span><span class="n">fullname</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">VARCHAR</span>
<span class="k">RETURN</span><span class="w"> </span><span class="s1">&#39;Hello, &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">fullname</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;!&#39;</span>
</code></pre></div>
</div>
<p>Following is an example invocation:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">hello</span><span class="p">(</span><span class="s1">&#39;Jane Doe&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">-- Hello, Jane Doe!</span>
</code></pre></div>
</div>
<p>A first example UDF, that uses multiple statements in a <code class="docutils literal notranslate"><span class="pre">BEGIN</span></code> block. It
calculates the result of a multiplication of the input integer with <code class="docutils literal notranslate"><span class="pre">99</span></code>. The
<code class="docutils literal notranslate"><span class="pre">bigint</span></code> data type is used for all variables and values. The value of integer
<code class="docutils literal notranslate"><span class="pre">99</span></code> is cast to <code class="docutils literal notranslate"><span class="pre">bigint</span></code> in the default value assignment for the variable <code class="docutils literal notranslate"><span class="pre">x</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">times_ninety_nine</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="nb">bigint</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">bigint</span>
<span class="k">BEGIN</span>
<span class="w">  </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="mi">99</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">bigint</span><span class="p">);</span>
<span class="w">  </span><span class="k">RETURN</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="k">END</span>
</code></pre></div>
</div>
<p>Following is an example invocation:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">times_ninety_nine</span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">bigint</span><span class="p">));</span><span class="w"> </span><span class="c1">-- 198</span>
</code></pre></div>
</div>
<h2 id="conditional-flows">Conditional flows<a class="headerlink" href="#conditional-flows" title="Link to this heading">#</a></h2>
<p>A first example of conditional flow control in a SQL UDF using the <code class="docutils literal notranslate"><span class="pre">CASE</span></code>
statement. The simple <code class="docutils literal notranslate"><span class="pre">bigint</span></code> input value is compared to a number of values:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">simple_case</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="nb">bigint</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">varchar</span>
<span class="k">BEGIN</span>
<span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="n">a</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="s1">&#39;zero&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="s1">&#39;one&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="s1">&#39;ten&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="s1">&#39;twenty&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">ELSE</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="s1">&#39;other&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="k">END</span><span class="w"> </span><span class="k">CASE</span><span class="p">;</span>
<span class="w">  </span><span class="k">RETURN</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
<span class="k">END</span>
</code></pre></div>
</div>
<p>Following are a couple of example invocations with result and explanation:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">simple_case</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">-- zero</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">simple_case</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">-- one</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">simple_case</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">-- other (from else clause)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">simple_case</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span><span class="w"> </span><span class="c1">-- ten</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">simple_case</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span><span class="w"> </span><span class="c1">-- other (from else clause)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">simple_case</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span><span class="w"> </span><span class="c1">-- twenty</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">simple_case</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"> </span><span class="c1">-- other (from else clause)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">simple_case</span><span class="p">(</span><span class="k">null</span><span class="p">);</span><span class="w"> </span><span class="c1">-- null .. but really??</span>
</code></pre></div>
</div>
<p>A second example of a SQL UDF with a <code class="docutils literal notranslate"><span class="pre">CASE</span></code> statement, this time with two
parameters, showcasing the importance of the order of the conditions:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">search_case</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="nb">bigint</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">varchar</span>
<span class="k">BEGIN</span>
<span class="w">  </span><span class="k">CASE</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="s1">&#39;zero&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="s1">&#39;one&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="w"> </span><span class="s1">&#39;10.0&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="s1">&#39;ten&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">.</span><span class="mi">0</span><span class="n">E0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="s1">&#39;twenty&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">ELSE</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="s1">&#39;other&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="k">END</span><span class="w"> </span><span class="k">CASE</span><span class="p">;</span>
<span class="w">  </span><span class="k">RETURN</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
<span class="k">END</span>
</code></pre></div>
</div>
<p>Following are a couple of example invocations with result and explanation:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">search_case</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">-- zero</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">search_case</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">-- one</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">search_case</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">-- zero (not one since the second check is never reached)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">search_case</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">-- one (not ten since the third check is never reached)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">search_case</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">-- ten</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">search_case</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">);</span><span class="w"> </span><span class="c1">-- ten (not twenty)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">search_case</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="p">);</span><span class="w"> </span><span class="c1">-- zero (not twenty)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">search_case</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">20</span><span class="p">);</span><span class="w"> </span><span class="c1">-- twenty</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">search_case</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">21</span><span class="p">);</span><span class="w"> </span><span class="c1">-- other</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">simple_case</span><span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="k">null</span><span class="p">);</span><span class="w"> </span><span class="c1">-- null .. but really??</span>
</code></pre></div>
</div>
<h2 id="fibonacci-example">Fibonacci example<a class="headerlink" href="#fibonacci-example" title="Link to this heading">#</a></h2>
<p>This SQL UDF calculates the <code class="docutils literal notranslate"><span class="pre">n</span></code>-th value in the Fibonacci series, in which each
number is the sum of the two preceding ones. The two initial values are set to
<code class="docutils literal notranslate"><span class="pre">1</span></code> as the defaults for <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code>. The UDF uses an <code class="docutils literal notranslate"><span class="pre">IF</span></code> statement condition to
return <code class="docutils literal notranslate"><span class="pre">1</span></code> for all input values of <code class="docutils literal notranslate"><span class="pre">2</span></code> or less. The <code class="docutils literal notranslate"><span class="pre">WHILE</span></code> block then starts to
calculate each number in the series, starting with <code class="docutils literal notranslate"><span class="pre">a=1</span></code> and <code class="docutils literal notranslate"><span class="pre">b=1</span></code> and iterates
until it reaches the <code class="docutils literal notranslate"><span class="pre">n</span></code>-th position. In each iteration it sets <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> for
the preceding to values, so it can calculate the sum, and finally return it.
Note that processing the UDF takes longer and longer with higher <code class="docutils literal notranslate"><span class="pre">n</span></code> values, and
the result is deterministic:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="nb">bigint</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">bigint</span>
<span class="k">BEGIN</span>
<span class="w">  </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">DECLARE</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="nb">bigint</span><span class="p">;</span>
<span class="w">  </span><span class="k">IF</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">  </span><span class="n">WHILE</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DO</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">;</span>
<span class="w">  </span><span class="k">END</span><span class="w"> </span><span class="n">WHILE</span><span class="p">;</span>
<span class="w">  </span><span class="k">RETURN</span><span class="w"> </span><span class="k">c</span><span class="p">;</span>
<span class="k">END</span>
</code></pre></div>
</div>
<p>Following are a couple of example invocations with result and explanation:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 1</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 1</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 1</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 1</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 2</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 3</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 5</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 8</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 13</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 21</span>
</code></pre></div>
</div>
<h2 id="labels-and-loops">Labels and loops<a class="headerlink" href="#labels-and-loops" title="Link to this heading">#</a></h2>
<p>This SQL UDF uses the <code class="docutils literal notranslate"><span class="pre">top</span></code> label to name the <code class="docutils literal notranslate"><span class="pre">WHILE</span></code> block, and then controls
the flow with conditional statements, <code class="docutils literal notranslate"><span class="pre">ITERATE</span></code>, and <code class="docutils literal notranslate"><span class="pre">LEAVE</span></code>. For the values of
<code class="docutils literal notranslate"><span class="pre">a=1</span></code> and <code class="docutils literal notranslate"><span class="pre">a=2</span></code> in the first two iterations of the loop the <code class="docutils literal notranslate"><span class="pre">ITERATE</span></code> call moves
the flow up to <code class="docutils literal notranslate"><span class="pre">top</span></code> before <code class="docutils literal notranslate"><span class="pre">b</span></code> is ever increased. Then <code class="docutils literal notranslate"><span class="pre">b</span></code> is increased for the
values <code class="docutils literal notranslate"><span class="pre">a=3</span></code>, <code class="docutils literal notranslate"><span class="pre">a=4</span></code>, <code class="docutils literal notranslate"><span class="pre">a=5</span></code>, <code class="docutils literal notranslate"><span class="pre">a=6</span></code>, and <code class="docutils literal notranslate"><span class="pre">a=7</span></code>, resulting in <code class="docutils literal notranslate"><span class="pre">b=5</span></code>. The <code class="docutils literal notranslate"><span class="pre">LEAVE</span></code>
call then causes the exit of the block before a is increased further to <code class="docutils literal notranslate"><span class="pre">10</span></code> and
therefore the result of the UDF is <code class="docutils literal notranslate"><span class="pre">5</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">labels</span><span class="p">()</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">bigint</span>
<span class="k">BEGIN</span>
<span class="w">  </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">top</span><span class="p">:</span><span class="w"> </span><span class="n">WHILE</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">DO</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">      </span><span class="k">ITERATE</span><span class="w"> </span><span class="n">top</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">      </span><span class="n">LEAVE</span><span class="w"> </span><span class="n">top</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">  </span><span class="k">END</span><span class="w"> </span><span class="n">WHILE</span><span class="p">;</span>
<span class="w">  </span><span class="k">RETURN</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="k">END</span>
</code></pre></div>
</div>
<p>This SQL UDF implements calculating the <code class="docutils literal notranslate"><span class="pre">n</span></code> to the power of <code class="docutils literal notranslate"><span class="pre">p</span></code> by repeated
multiplication and keeping track of the number of multiplications performed.
Note that this SQL UDF does not return the correct <code class="docutils literal notranslate"><span class="pre">0</span></code> for <code class="docutils literal notranslate"><span class="pre">p=0</span></code> since the <code class="docutils literal notranslate"><span class="pre">top</span></code>
block is merely escaped and the value of <code class="docutils literal notranslate"><span class="pre">n</span></code> is returned. The same incorrect
behavior happens for negative values of <code class="docutils literal notranslate"><span class="pre">p</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">power</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">int</span>
<span class="w">  </span><span class="k">BEGIN</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">    </span><span class="n">top</span><span class="p">:</span><span class="w"> </span><span class="n">LOOP</span>
<span class="w">      </span><span class="k">IF</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="n">LEAVE</span><span class="w"> </span><span class="n">top</span><span class="p">;</span>
<span class="w">      </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">LOOP</span><span class="p">;</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<span class="w">  </span><span class="k">END</span>
</code></pre></div>
</div>
<p>Following are a couple of example invocations with result and explanation:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 4</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 256</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">power</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 256</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">power</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 3, which is wrong</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">power</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 3, which is wrong</span>
</code></pre></div>
</div>
<p>This SQL UDF returns <code class="docutils literal notranslate"><span class="pre">7</span></code> as a result of the increase of <code class="docutils literal notranslate"><span class="pre">b</span></code> in the loop from
<code class="docutils literal notranslate"><span class="pre">a=3</span></code> to <code class="docutils literal notranslate"><span class="pre">a=10</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">test_repeat_continue</span><span class="p">()</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">bigint</span>
<span class="k">BEGIN</span>
<span class="w">  </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">top</span><span class="p">:</span><span class="w"> </span><span class="n">REPEAT</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">      </span><span class="k">ITERATE</span><span class="w"> </span><span class="n">top</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">UNTIL</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">10</span>
<span class="w">  </span><span class="k">END</span><span class="w"> </span><span class="n">REPEAT</span><span class="p">;</span>
<span class="w">  </span><span class="k">RETURN</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="k">END</span>
</code></pre></div>
</div>
<p>This SQL UDF returns <code class="docutils literal notranslate"><span class="pre">2</span></code> and shows that labels can be repeated and label usage
within a block refers to the label of that block:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">test</span><span class="p">()</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">int</span>
<span class="k">BEGIN</span>
<span class="w">  </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">abc</span><span class="p">:</span><span class="w"> </span><span class="n">LOOP</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">LEAVE</span><span class="w"> </span><span class="n">abc</span><span class="p">;</span>
<span class="w">  </span><span class="k">END</span><span class="w"> </span><span class="n">LOOP</span><span class="p">;</span>
<span class="w">  </span><span class="n">abc</span><span class="p">:</span><span class="w"> </span><span class="n">LOOP</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">LEAVE</span><span class="w"> </span><span class="n">abc</span><span class="p">;</span>
<span class="w">  </span><span class="k">END</span><span class="w"> </span><span class="n">LOOP</span><span class="p">;</span>
<span class="w">  </span><span class="k">RETURN</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<span class="k">END</span>
</code></pre></div>
</div>
<h2 id="sql-udfs-and-built-in-functions">SQL UDFs and built-in functions<a class="headerlink" href="#sql-udfs-and-built-in-functions" title="Link to this heading">#</a></h2>
<p>This SQL UDF shows that multiple data types and built-in functions like
<code class="docutils literal notranslate"><span class="pre">length()</span></code> and <code class="docutils literal notranslate"><span class="pre">cardinality()</span></code> can be used in a UDF. The two nested <code class="docutils literal notranslate"><span class="pre">BEGIN</span></code>
blocks also show how variable names are local within these blocks <code class="docutils literal notranslate"><span class="pre">x</span></code>, but the
global <code class="docutils literal notranslate"><span class="pre">r</span></code> from the top-level block can be accessed in the nested blocks:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">test</span><span class="p">()</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">bigint</span>
<span class="k">BEGIN</span>
<span class="w">  </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">BEGIN</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">varchar</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;hello&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">length</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="w">  </span><span class="k">END</span><span class="p">;</span>
<span class="w">  </span><span class="k">BEGIN</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nb">array</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="nb">array</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">];</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">cardinality</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="w">  </span><span class="k">END</span><span class="p">;</span>
<span class="w">  </span><span class="k">RETURN</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<span class="k">END</span>
</code></pre></div>
</div>
<h2 id="optional-parameter-example">Optional parameter example<a class="headerlink" href="#optional-parameter-example" title="Link to this heading">#</a></h2>
<p>UDFs can invoke other UDFs and other functions. The full signature of a UDF is
composed of the UDF name and parameters, and determines the exact UDF to use.
You can declare multiple UDFs with the same name, but with a different number of
arguments or different argument types. One example use case is to implement an
optional parameter.</p>
<p>The following SQL UDF truncates a string to the specified length including three
dots at the end of the output:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">dots</span><span class="p">(</span><span class="k">input</span><span class="w"> </span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="k">length</span><span class="w"> </span><span class="nb">integer</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">varchar</span>
<span class="k">BEGIN</span>
<span class="w">  </span><span class="k">IF</span><span class="w"> </span><span class="k">length</span><span class="p">(</span><span class="k">input</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">length</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="k">substring</span><span class="p">(</span><span class="k">input</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">length</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;...&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">  </span><span class="k">RETURN</span><span class="w"> </span><span class="k">input</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
</code></pre></div>
</div>
<p>Following are example invocations and output:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">dots</span><span class="p">(</span><span class="s1">&#39;A long string that will be shortened&#39;</span><span class="p">,</span><span class="mi">15</span><span class="p">);</span>
<span class="c1">-- A long strin...</span>
<span class="k">SELECT</span><span class="w">	</span><span class="n">dots</span><span class="p">(</span><span class="s1">&#39;A short string&#39;</span><span class="p">,</span><span class="mi">15</span><span class="p">);</span>
<span class="c1">-- A short string</span>
</code></pre></div>
</div>
<p>If you want to provide a UDF with the same name, but without the parameter
for length, you can create another UDF that invokes the preceding UDF:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">dots</span><span class="p">(</span><span class="k">input</span><span class="w"> </span><span class="nb">varchar</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">varchar</span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">dots</span><span class="p">(</span><span class="k">input</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">);</span>
</code></pre></div>
</div>
<p>You can now use both UDFs. When the length parameter is omitted, the default
value from the second declaration is used.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">dots</span><span class="p">(</span><span class="s1">&#39;A long string that will be shortened&#39;</span><span class="p">,</span><span class="mi">15</span><span class="p">);</span>
<span class="c1">-- A long strin...</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">dots</span><span class="p">(</span><span class="s1">&#39;A long string that will be shortened&#39;</span><span class="p">);</span>
<span class="c1">-- A long strin...</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">dots</span><span class="p">(</span><span class="s1">&#39;A long string that will be shortened&#39;</span><span class="p">,</span><span class="mi">20</span><span class="p">);</span>
<span class="c1">-- A long string tha...</span>
</code></pre></div>
</div>
<h2 id="date-string-parsing-example">Date string parsing example<a class="headerlink" href="#date-string-parsing-example" title="Link to this heading">#</a></h2>
<p>This example SQL UDF parses a date string of type <code class="docutils literal notranslate"><span class="pre">VARCHAR</span></code> into <code class="docutils literal notranslate"><span class="pre">TIMESTAMP</span> <span class="pre">WITH</span> <span class="pre">TIME</span> <span class="pre">ZONE</span></code>. Date strings are commonly represented by ISO 8601 standard, such as
<code class="docutils literal notranslate"><span class="pre">2023-12-01</span></code>, <code class="docutils literal notranslate"><span class="pre">2023-12-01T23</span></code>. Date strings are also often represented in the
<code class="docutils literal notranslate"><span class="pre">YYYYmmdd</span></code> and <code class="docutils literal notranslate"><span class="pre">YYYYmmddHH</span></code> format, such as <code class="docutils literal notranslate"><span class="pre">20230101</span></code> and <code class="docutils literal notranslate"><span class="pre">2023010123</span></code>. Hive
tables can use this format to represent day and hourly partitions, for example
<code class="docutils literal notranslate"><span class="pre">/day=20230101</span></code>, <code class="docutils literal notranslate"><span class="pre">/hour=2023010123</span></code>.</p>
<p>This UDF parses date strings in a best-effort fashion and can be used as a
replacement for date string manipulation functions such as <code class="docutils literal notranslate"><span class="pre">date</span></code>, <code class="docutils literal notranslate"><span class="pre">date_parse</span></code>,
<code class="docutils literal notranslate"><span class="pre">from_iso8601_date</span></code>,  and <code class="docutils literal notranslate"><span class="pre">from_iso8601_timestamp</span></code>.</p>
<p>Note that the UDF defaults the time value to <code class="docutils literal notranslate"><span class="pre">00:00:00.000</span></code> and the time
zone to the session time zone:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">from_date_string</span><span class="p">(</span><span class="n">date_string</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span>
<span class="k">BEGIN</span>
<span class="w">  </span><span class="k">IF</span><span class="w"> </span><span class="n">date_string</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%-%&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c1">-- ISO 8601</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">from_iso8601_timestamp</span><span class="p">(</span><span class="n">date_string</span><span class="p">);</span>
<span class="w">  </span><span class="n">ELSEIF</span><span class="w"> </span><span class="k">length</span><span class="p">(</span><span class="n">date_string</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c1">-- YYYYmmdd</span>
<span class="w">      </span><span class="k">RETURN</span><span class="w"> </span><span class="n">date_parse</span><span class="p">(</span><span class="n">date_string</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;%Y%m%d&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="n">ELSEIF</span><span class="w"> </span><span class="k">length</span><span class="p">(</span><span class="n">date_string</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c1">-- YYYYmmddHH</span>
<span class="w">      </span><span class="k">RETURN</span><span class="w"> </span><span class="n">date_parse</span><span class="p">(</span><span class="n">date_string</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;%Y%m%d%H&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">  </span><span class="k">RETURN</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
<span class="k">END</span>
</code></pre></div>
</div>
<p>Following are a couple of example invocations with result and explanation:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">from_date_string</span><span class="p">(</span><span class="s1">&#39;2023-01-01&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 2023-01-01 00:00:00.000 UTC (using the ISO 8601 format)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">from_date_string</span><span class="p">(</span><span class="s1">&#39;2023-01-01T23&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 2023-01-01 23:00:00.000 UTC (using the ISO 8601 format)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">from_date_string</span><span class="p">(</span><span class="s1">&#39;2023-01-01T23:23:23&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 2023-01-01 23:23:23.000 UTC (using the ISO 8601 format)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">from_date_string</span><span class="p">(</span><span class="s1">&#39;20230101&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 2023-01-01 00:00:00.000 UTC (using the YYYYmmdd format)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">from_date_string</span><span class="p">(</span><span class="s1">&#39;2023010123&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">-- 2023-01-01 23:00:00.000 UTC (using the YYYYmmddHH format)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">from_date_string</span><span class="p">(</span><span class="k">NULL</span><span class="p">);</span><span class="w"> </span><span class="c1">-- NULL (handles NULL string)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">from_date_string</span><span class="p">(</span><span class="s1">&#39;abc&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">-- NULL (not matched to any format)</span>
</code></pre></div>
</div>
<h2 id="human-readable-days">Human-readable days<a class="headerlink" href="#human-readable-days" title="Link to this heading">#</a></h2>
<p>Trino includes a built-in function called <a class="reference internal" href="../../functions/datetime.html#human_readable_seconds" title="human_readable_seconds (Python function)  Formats the double value of seconds into a human-readable string containing weeks, days, hours, minutes, and seconds:"><code class="xref py py-func docutils literal notranslate"><span class="pre">human_readable_seconds()</span></code></a> that
formats a number of seconds into a string:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">human_readable_seconds</span><span class="p">(</span><span class="mi">134823</span><span class="p">);</span>
<span class="c1">-- 1 day, 13 hours, 27 minutes, 3 seconds</span>
</code></pre></div>
</div>
<p>The example SQL UDF <code class="docutils literal notranslate"><span class="pre">hrd</span></code> formats a number of days into a human-readable text
that provides the approximate number of years and months:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">hrd</span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="nb">integer</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">VARCHAR</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">answer</span><span class="w"> </span><span class="nb">varchar</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;About &#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">years</span><span class="w"> </span><span class="nb">real</span><span class="p">;</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">months</span><span class="w"> </span><span class="nb">real</span><span class="p">;</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">years</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">truncate</span><span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="mi">365</span><span class="p">);</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">years</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">answer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">answer</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;%1.0f&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">years</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; year&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">years</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">answer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">answer</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;s&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="w"> </span><span class="n">years</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">integer</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">365</span><span class="w"> </span><span class="p">;</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">months</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">truncate</span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">30</span><span class="p">);</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">months</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">years</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">answer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">answer</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; and &#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">months</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="k">set</span><span class="w"> </span><span class="n">answer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">answer</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;%1.0f&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">months</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; month&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">months</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">answer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">answer</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;s&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">years</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">months</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">answer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Less than 1 month&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">answer</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
</code></pre></div>
</div>
<p>The following examples show the output for a range of values under one month,
under one year, and various larger values:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">hrd</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span><span class="w"> </span><span class="c1">-- Less than 1 month</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">hrd</span><span class="p">(</span><span class="mi">95</span><span class="p">);</span><span class="w"> </span><span class="c1">-- About 3 months</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">hrd</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span><span class="w"> </span><span class="c1">-- About 1 year and 1 month</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">hrd</span><span class="p">(</span><span class="mi">369</span><span class="p">);</span><span class="w"> </span><span class="c1">-- About 1 year</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">hrd</span><span class="p">(</span><span class="mi">800</span><span class="p">);</span><span class="w"> </span><span class="c1">-- About 2 years and 2 months</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">hrd</span><span class="p">(</span><span class="mi">1100</span><span class="p">);</span><span class="w"> </span><span class="c1">-- About 3 years</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">hrd</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span><span class="w"> </span><span class="c1">-- About 13 years and 8 months</span>
</code></pre></div>
</div>
<p>Improvements of the SQL UDF could include the following modifications:</p>
<ul class="simple">
<li><p>Take into account that one month equals 30.4375 days.</p></li>
<li><p>Take into account that one year equals 365.25 days.</p></li>
<li><p>Add weeks to the output.</p></li>
<li><p>Expand to cover decades, centuries, and millennia.</p></li>
</ul>
<h2 id="truncating-long-strings">Truncating long strings<a class="headerlink" href="#truncating-long-strings" title="Link to this heading">#</a></h2>
<p>This example SQL UDF <code class="docutils literal notranslate"><span class="pre">strtrunc</span></code> truncates strings longer than 60 characters,
leaving the first 30 and the last 25 characters, and cutting out extra
characters in the middle:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">strtrunc</span><span class="p">(</span><span class="k">input</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">VARCHAR</span>
<span class="k">RETURN</span>
<span class="w">    </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="k">length</span><span class="p">(</span><span class="k">input</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span>
<span class="w">    </span><span class="k">THEN</span><span class="w"> </span><span class="n">substr</span><span class="p">(</span><span class="k">input</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; ... &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">substr</span><span class="p">(</span><span class="k">input</span><span class="p">,</span><span class="w"> </span><span class="k">length</span><span class="p">(</span><span class="k">input</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">25</span><span class="p">)</span>
<span class="w">    </span><span class="k">ELSE</span><span class="w"> </span><span class="k">input</span>
<span class="w">    </span><span class="k">END</span><span class="p">;</span>
</code></pre></div>
</div>
<p>The preceding declaration is very compact and consists of only one complex
statement with a <a class="reference internal" href="../../functions/conditional.html#case-expression"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">CASE</span></code> expression</span></a> and multiple function
calls. It can therefore define the complete logic in the <code class="docutils literal notranslate"><span class="pre">RETURN</span></code> clause.</p>
<p>The following statement shows the same capability within the SQL UDF itself.
Note the duplicate <code class="docutils literal notranslate"><span class="pre">RETURN</span></code> inside and outside the <code class="docutils literal notranslate"><span class="pre">CASE</span></code> statement and the
required <code class="docutils literal notranslate"><span class="pre">END</span> <span class="pre">CASE;</span></code>. The second <code class="docutils literal notranslate"><span class="pre">RETURN</span></code> statement is required, because a SQL
UDF must end with a <code class="docutils literal notranslate"><span class="pre">RETURN</span></code> statement. As a result the <code class="docutils literal notranslate"><span class="pre">ELSE</span></code> clause can be
omitted:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">strtrunc</span><span class="p">(</span><span class="k">input</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">VARCHAR</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="k">length</span><span class="p">(</span><span class="k">input</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span>
<span class="w">    </span><span class="k">THEN</span>
<span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="n">substr</span><span class="p">(</span><span class="k">input</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; ... &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">substr</span><span class="p">(</span><span class="k">input</span><span class="p">,</span><span class="w"> </span><span class="k">length</span><span class="p">(</span><span class="k">input</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">25</span><span class="p">);</span>
<span class="w">    </span><span class="k">ELSE</span>
<span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="k">input</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">CASE</span><span class="p">;</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="k">input</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
</code></pre></div>
</div>
<p>The next example changes over from a <code class="docutils literal notranslate"><span class="pre">CASE</span></code> to an <code class="docutils literal notranslate"><span class="pre">IF</span></code> statement, and avoids the
duplicate <code class="docutils literal notranslate"><span class="pre">RETURN</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">strtrunc</span><span class="p">(</span><span class="k">input</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">VARCHAR</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">length</span><span class="p">(</span><span class="k">input</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="n">substr</span><span class="p">(</span><span class="k">input</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39; ... &#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">substr</span><span class="p">(</span><span class="k">input</span><span class="p">,</span><span class="w"> </span><span class="k">length</span><span class="p">(</span><span class="k">input</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">25</span><span class="p">);</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="k">input</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
</code></pre></div>
</div>
<p>All the preceding examples create the same output. Following is an example query
which generates long strings to truncate:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">WITH</span>
<span class="k">data</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="k">substring</span><span class="p">(</span><span class="s1">&#39;strtrunc truncates strings longer than 60 characters,</span>
<span class="s1">     leaving the prefix and suffix visible&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">value</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="k">table</span><span class="p">(</span><span class="n">sequence</span><span class="p">(</span><span class="k">start</span><span class="o">=&gt;</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="o">=&gt;</span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="n">step</span><span class="o">=&gt;</span><span class="mi">5</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="k">data</span><span class="p">.</span><span class="n">value</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">strtrunc</span><span class="p">(</span><span class="k">data</span><span class="p">.</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">truncated</span>
<span class="k">FROM</span><span class="w"> </span><span class="k">data</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
</code></pre></div>
</div>
<p>The preceding query produces the following output with all variants of the SQL
UDF:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="w">                                      </span><span class="n">value</span><span class="w">                                       </span><span class="o">|</span><span class="w">                           </span><span class="n">truncated</span>
<span class="c1">----------------------------------------------------------------------------------+---------------------------------------------------------------</span>
<span class="w"> </span><span class="n">strtrunc</span><span class="w"> </span><span class="n">truncates</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="mi">6</span><span class="w">                                         </span><span class="o">|</span><span class="w"> </span><span class="n">strtrunc</span><span class="w"> </span><span class="n">truncates</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="mi">6</span>
<span class="w"> </span><span class="n">strtrunc</span><span class="w"> </span><span class="n">truncates</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">cha</span><span class="w">                                    </span><span class="o">|</span><span class="w"> </span><span class="n">strtrunc</span><span class="w"> </span><span class="n">truncates</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">cha</span>
<span class="w"> </span><span class="n">strtrunc</span><span class="w"> </span><span class="n">truncates</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">characte</span><span class="w">                               </span><span class="o">|</span><span class="w"> </span><span class="n">strtrunc</span><span class="w"> </span><span class="n">truncates</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">characte</span>
<span class="w"> </span><span class="n">strtrunc</span><span class="w"> </span><span class="n">truncates</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">characters</span><span class="p">,</span><span class="w"> </span><span class="n">l</span><span class="w">                          </span><span class="o">|</span><span class="w"> </span><span class="n">strtrunc</span><span class="w"> </span><span class="n">truncates</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">characters</span><span class="p">,</span><span class="w"> </span><span class="n">l</span>
<span class="w"> </span><span class="n">strtrunc</span><span class="w"> </span><span class="n">truncates</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">characters</span><span class="p">,</span><span class="w"> </span><span class="n">leavin</span><span class="w">                     </span><span class="o">|</span><span class="w"> </span><span class="n">strtrunc</span><span class="w"> </span><span class="n">truncates</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">characters</span><span class="p">,</span><span class="w"> </span><span class="n">leavin</span>
<span class="w"> </span><span class="n">strtrunc</span><span class="w"> </span><span class="n">truncates</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">characters</span><span class="p">,</span><span class="w"> </span><span class="n">leaving</span><span class="w"> </span><span class="n">the</span><span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">strtrunc</span><span class="w"> </span><span class="n">truncates</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">lon</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">characters</span><span class="p">,</span><span class="w"> </span><span class="n">leaving</span><span class="w"> </span><span class="n">the</span>
<span class="w"> </span><span class="n">strtrunc</span><span class="w"> </span><span class="n">truncates</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">characters</span><span class="p">,</span><span class="w"> </span><span class="n">leaving</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">pref</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="n">strtrunc</span><span class="w"> </span><span class="n">truncates</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">lon</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">aracters</span><span class="p">,</span><span class="w"> </span><span class="n">leaving</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">pref</span>
<span class="w"> </span><span class="n">strtrunc</span><span class="w"> </span><span class="n">truncates</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">characters</span><span class="p">,</span><span class="w"> </span><span class="n">leaving</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">prefix</span><span class="w"> </span><span class="n">an</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">strtrunc</span><span class="w"> </span><span class="n">truncates</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">lon</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">ers</span><span class="p">,</span><span class="w"> </span><span class="n">leaving</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">prefix</span><span class="w"> </span><span class="n">an</span>
<span class="w"> </span><span class="n">strtrunc</span><span class="w"> </span><span class="n">truncates</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="n">characters</span><span class="p">,</span><span class="w"> </span><span class="n">leaving</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">prefix</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">suf</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">strtrunc</span><span class="w"> </span><span class="n">truncates</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">lon</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">leaving</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">prefix</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">suf</span>
</code></pre></div>
</div>
<p>A possible improvement is to introduce parameters for the total length.</p>
<h2 id="formatting-bytes">Formatting bytes<a class="headerlink" href="#formatting-bytes" title="Link to this heading">#</a></h2>
<p>Trino includes a built-in <code class="docutils literal notranslate"><span class="pre">format_number()</span></code> function. However, it is using units
that do not work well with bytes. The following <code class="docutils literal notranslate"><span class="pre">format_data_size</span></code> SQL UDF can
format large values of bytes into a human-readable string:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">format_data_size</span><span class="p">(</span><span class="k">input</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">VARCHAR</span>
<span class="w">  </span><span class="k">BEGIN</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">DOUBLE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="k">input</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">DOUBLE</span><span class="p">);</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="k">result</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">;</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;B&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">;</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;kB&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;MB&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;GB&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;TB&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;PB&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;EB&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ZB&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;YB&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;%.2f&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">ELSEIF</span><span class="w"> </span><span class="k">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;%.1f&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">ELSE</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;%.0f&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span>
<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">format</span><span class="p">(</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">unit</span><span class="p">;</span>
<span class="w">  </span><span class="k">END</span><span class="p">;</span>
</code></pre></div>
</div>
<p>Below is a query that shows how it formats a wide range of values:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">WITH</span>
<span class="k">data</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="k">table</span><span class="p">(</span><span class="n">sequence</span><span class="p">(</span><span class="k">start</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="o">=&gt;</span><span class="mi">18</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="w">    </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="o">-</span><span class="k">CAST</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="k">table</span><span class="p">(</span><span class="n">sequence</span><span class="p">(</span><span class="k">start</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="o">=&gt;</span><span class="mi">18</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="k">data</span><span class="p">.</span><span class="n">num</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">format_data_size</span><span class="p">(</span><span class="k">data</span><span class="p">.</span><span class="n">num</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">formatted</span>
<span class="k">FROM</span><span class="w"> </span><span class="k">data</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>
</code></pre></div>
</div>
<p>The preceding query produces the following output:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="w">         </span><span class="n">num</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="n">formatted</span>
<span class="c1">----------------------+-----------</span>
<span class="w"> </span><span class="o">-</span><span class="mi">1000000000000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="mi">888</span><span class="n">PB</span>
<span class="w">  </span><span class="o">-</span><span class="mi">100000000000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="mi">88</span><span class="p">.</span><span class="mi">8</span><span class="n">PB</span>
<span class="w">   </span><span class="o">-</span><span class="mi">10000000000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="mi">8</span><span class="p">.</span><span class="mi">88</span><span class="n">PB</span>
<span class="w">    </span><span class="o">-</span><span class="mi">1000000000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="mi">909</span><span class="n">TB</span>
<span class="w">     </span><span class="o">-</span><span class="mi">100000000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="mi">90</span><span class="p">.</span><span class="mi">9</span><span class="n">TB</span>
<span class="w">      </span><span class="o">-</span><span class="mi">10000000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="mi">9</span><span class="p">.</span><span class="mi">09</span><span class="n">TB</span>
<span class="w">       </span><span class="o">-</span><span class="mi">1000000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="mi">931</span><span class="n">GB</span>
<span class="w">        </span><span class="o">-</span><span class="mi">100000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="mi">93</span><span class="p">.</span><span class="mi">1</span><span class="n">GB</span>
<span class="w">         </span><span class="o">-</span><span class="mi">10000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="mi">9</span><span class="p">.</span><span class="mi">31</span><span class="n">GB</span>
<span class="w">          </span><span class="o">-</span><span class="mi">1000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="mi">954</span><span class="n">MB</span>
<span class="w">           </span><span class="o">-</span><span class="mi">100000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="mi">95</span><span class="p">.</span><span class="mi">4</span><span class="n">MB</span>
<span class="w">            </span><span class="o">-</span><span class="mi">10000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="mi">9</span><span class="p">.</span><span class="mi">54</span><span class="n">MB</span>
<span class="w">             </span><span class="o">-</span><span class="mi">1000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="mi">977</span><span class="n">kB</span>
<span class="w">              </span><span class="o">-</span><span class="mi">100000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="mi">97</span><span class="p">.</span><span class="mi">7</span><span class="n">kB</span>
<span class="w">               </span><span class="o">-</span><span class="mi">10000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="mi">9</span><span class="p">.</span><span class="mi">77</span><span class="n">kB</span>
<span class="w">                </span><span class="o">-</span><span class="mi">1000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="mi">1000</span><span class="n">B</span>
<span class="w">                 </span><span class="o">-</span><span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="mi">100</span><span class="n">B</span>
<span class="w">                  </span><span class="o">-</span><span class="mi">10</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="n">B</span>
<span class="w">                    </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="n">B</span>
<span class="w">                   </span><span class="mi">10</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="n">B</span>
<span class="w">                  </span><span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">100</span><span class="n">B</span>
<span class="w">                 </span><span class="mi">1000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1000</span><span class="n">B</span>
<span class="w">                </span><span class="mi">10000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">9</span><span class="p">.</span><span class="mi">77</span><span class="n">kB</span>
<span class="w">               </span><span class="mi">100000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">97</span><span class="p">.</span><span class="mi">7</span><span class="n">kB</span>
<span class="w">              </span><span class="mi">1000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">977</span><span class="n">kB</span>
<span class="w">             </span><span class="mi">10000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">9</span><span class="p">.</span><span class="mi">54</span><span class="n">MB</span>
<span class="w">            </span><span class="mi">100000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">95</span><span class="p">.</span><span class="mi">4</span><span class="n">MB</span>
<span class="w">           </span><span class="mi">1000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">954</span><span class="n">MB</span>
<span class="w">          </span><span class="mi">10000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">9</span><span class="p">.</span><span class="mi">31</span><span class="n">GB</span>
<span class="w">         </span><span class="mi">100000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">93</span><span class="p">.</span><span class="mi">1</span><span class="n">GB</span>
<span class="w">        </span><span class="mi">1000000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">931</span><span class="n">GB</span>
<span class="w">       </span><span class="mi">10000000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">9</span><span class="p">.</span><span class="mi">09</span><span class="n">TB</span>
<span class="w">      </span><span class="mi">100000000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">90</span><span class="p">.</span><span class="mi">9</span><span class="n">TB</span>
<span class="w">     </span><span class="mi">1000000000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">909</span><span class="n">TB</span>
<span class="w">    </span><span class="mi">10000000000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">8</span><span class="p">.</span><span class="mi">88</span><span class="n">PB</span>
<span class="w">   </span><span class="mi">100000000000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">88</span><span class="p">.</span><span class="mi">8</span><span class="n">PB</span>
<span class="w">  </span><span class="mi">1000000000000000000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">888</span><span class="n">PB</span>
</code></pre></div>
</div>
<h2 id="charts">Charts<a class="headerlink" href="#charts" title="Link to this heading">#</a></h2>
<p>Trino already has a built-in <code class="docutils literal notranslate"><span class="pre">bar()</span></code> <a class="reference internal" href="../../functions/color.html"><span class="doc std std-doc">color function</span></a>, but it
is using ANSI escape codes to output colors, and thus is only usable for
displaying results in a terminal. The following example shows a similar SQL UDF
that only uses ASCII characters:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">ascii_bar</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="n">DOUBLE</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">VARCHAR</span>
<span class="k">BEGIN</span>
<span class="w">  </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">max_width</span><span class="w"> </span><span class="n">DOUBLE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">40</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">RETURN</span><span class="w"> </span><span class="n">array_join</span><span class="p">(</span>
<span class="w">    </span><span class="n">repeat</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="n">greatest</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">max_width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">integer</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="nb">ARRAY</span><span class="p">[</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">]</span>
<span class="w">        </span><span class="p">[</span><span class="k">cast</span><span class="p">((</span><span class="n">value</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">double</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">max_width</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">max_width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">int</span><span class="p">)];</span>
<span class="k">END</span><span class="p">;</span>
</code></pre></div>
</div>
<p>It can be used to visualize a value:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">WITH</span>
<span class="k">data</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span>
<span class="w">        </span><span class="k">cast</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">double</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">x</span><span class="p">,</span>
<span class="w">        </span><span class="n">sin</span><span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">num</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">double</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">y</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="k">table</span><span class="p">(</span><span class="n">sequence</span><span class="p">(</span><span class="k">start</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="o">=&gt;</span><span class="mi">314</span><span class="p">,</span><span class="w"> </span><span class="n">step</span><span class="o">=&gt;</span><span class="mi">10</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="k">data</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
<span class="w">    </span><span class="n">round</span><span class="p">(</span><span class="k">data</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">y</span><span class="p">,</span>
<span class="w">    </span><span class="n">ascii_bar</span><span class="p">(</span><span class="k">data</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">chart</span>
<span class="k">FROM</span><span class="w"> </span><span class="k">data</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</code></pre></div>
</div>
<p>The preceding query produces the following output:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><code>  x  |   y    |                  chart
-----+--------+-----------------------------------------
 0.0 |    0.0 |
 0.1 | 0.0998 | 
 0.2 | 0.1987 | 
 0.3 | 0.2955 | 
 0.4 | 0.3894 | 
 0.5 | 0.4794 | 
 0.6 | 0.5646 | 
 0.7 | 0.6442 | 
 0.8 | 0.7174 | 
 0.9 | 0.7833 | 
 1.0 | 0.8415 | 
 1.1 | 0.8912 | 
 1.2 |  0.932 | 
 1.3 | 0.9636 | 
 1.4 | 0.9854 | 
 1.5 | 0.9975 | 
 1.6 | 0.9996 | 
 1.7 | 0.9917 | 
 1.8 | 0.9738 | 
 1.9 | 0.9463 | 
 2.0 | 0.9093 | 
 2.1 | 0.8632 | 
 2.2 | 0.8085 | 
 2.3 | 0.7457 | 
 2.4 | 0.6755 | 
 2.5 | 0.5985 | 
 2.6 | 0.5155 | 
 2.7 | 0.4274 | 
 2.8 |  0.335 | 
 2.9 | 0.2392 | 
 3.0 | 0.1411 | 
 3.1 | 0.0416 | 
</code></pre></div>
</div>
<p>It is also possible to draw more compacted charts. Following is a SQL UDF
drawing vertical bars:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">vertical_bar</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="n">DOUBLE</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">VARCHAR</span>
<span class="k">RETURN</span><span class="w"> </span><span class="nb">ARRAY</span><span class="p">[</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">][</span><span class="k">cast</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">int</span><span class="p">)];</span>
</code></pre></div>
</div>
<p>It can be used to draw a distribution of values, in a single column:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">WITH</span>
<span class="n">measurements</span><span class="p">(</span><span class="n">sensor_id</span><span class="p">,</span><span class="w"> </span><span class="n">recorded_at</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">VALUES</span>
<span class="w">        </span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="s1">&#39;2023-01-01&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="s1">&#39;2023-01-03&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="s1">&#39;2023-01-04&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="s1">&#39;2023-01-05&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="s1">&#39;2023-01-08&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="s1">&#39;2023-01-09&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="s1">&#39;2023-01-10&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="s1">&#39;2023-01-11&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="s1">&#39;2023-01-03&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="s1">&#39;2023-01-04&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="s1">&#39;2023-01-05&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="s1">&#39;2023-01-07&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="mi">75</span><span class="p">)</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="s1">&#39;2023-01-09&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="s1">&#39;2023-01-10&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span>
<span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="s1">&#39;2023-01-11&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
<span class="p">),</span>
<span class="n">days</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">date_add</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">num</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="s1">&#39;2023-01-01&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">day</span>
<span class="w">    </span><span class="c1">-- table function arguments need to be constant but range could be calculated</span>
<span class="w">    </span><span class="c1">-- using: SELECT date_diff(&#39;day&#39;, max(recorded_at), min(recorded_at)) FROM measurements</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="k">table</span><span class="p">(</span><span class="n">sequence</span><span class="p">(</span><span class="k">start</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="o">=&gt;</span><span class="mi">10</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="p">),</span>
<span class="n">sensors</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)),</span>
<span class="n">normalized</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span>
<span class="w">        </span><span class="n">sensors</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sensor_id</span><span class="p">,</span>
<span class="w">        </span><span class="n">days</span><span class="p">.</span><span class="k">day</span><span class="p">,</span>
<span class="w">        </span><span class="n">value</span><span class="p">,</span>
<span class="w">        </span><span class="n">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">sensor_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">normalized</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">days</span>
<span class="w">    </span><span class="k">CROSS</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sensors</span>
<span class="w">    </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">day</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recorded_at</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">sensor_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sensors</span><span class="p">.</span><span class="n">id</span>
<span class="p">)</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">sensor_id</span><span class="p">,</span>
<span class="w">    </span><span class="k">min</span><span class="p">(</span><span class="k">day</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">start</span><span class="p">,</span>
<span class="w">    </span><span class="k">max</span><span class="p">(</span><span class="k">day</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">stop</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_values</span><span class="p">,</span>
<span class="w">    </span><span class="k">min</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">min_value</span><span class="p">,</span>
<span class="w">    </span><span class="k">max</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">max_value</span><span class="p">,</span>
<span class="w">    </span><span class="k">avg</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">avg_value</span><span class="p">,</span>
<span class="w">    </span><span class="n">array_join</span><span class="p">(</span><span class="n">array_agg</span><span class="p">(</span><span class="k">coalesce</span><span class="p">(</span><span class="n">vertical_bar</span><span class="p">(</span><span class="n">normalized</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">day</span><span class="p">),</span>
<span class="w">     </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">distribution</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">normalized</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">sensor_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">sensor_id</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">sensor_id</span><span class="p">;</span>
</code></pre></div>
</div>
<p>The preceding query produces the following output:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><code> sensor_id |   start    |    stop    | num_values | min_value | max_value | avg_value | distribution
-----------+------------+------------+------------+-----------+-----------+-----------+--------------
 A         | 2023-01-01 | 2023-01-11 |          8 |      1.00 |     15.00 |      8.38 |    
 B         | 2023-01-01 | 2023-01-11 |          7 |      1.00 |      4.00 |      2.39 |     
</code></pre></div>
</div>
<h2 id="top-n">Top-N<a class="headerlink" href="#top-n" title="Link to this heading">#</a></h2>
<p>Trino already has a built-in <a class="reference internal" href="../../functions/aggregate.html"><span class="doc std std-doc">aggregate function</span></a> called
<code class="docutils literal notranslate"><span class="pre">approx_most_frequent()</span></code> that can calculate the most frequently occurring
values. It returns a map with values as keys and number of occurrences as
values. Maps are not ordered, so when displayed, the entries can change places
on subsequent runs of the same query, and readers must still compare all
frequencies to find the one most frequent value. The following is a SQL UDF that
returns ordered results as a string:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">FUNCTION</span><span class="w"> </span><span class="n">format_topn</span><span class="p">(</span><span class="k">input</span><span class="w"> </span><span class="k">map</span><span class="o">&lt;</span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="nb">bigint</span><span class="o">&gt;</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">VARCHAR</span>
<span class="k">NOT</span><span class="w"> </span><span class="k">DETERMINISTIC</span>
<span class="k">BEGIN</span>
<span class="w">  </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">freq_separator</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;=&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">entry_separator</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;, &#39;</span><span class="p">;</span>
<span class="w">  </span><span class="k">RETURN</span><span class="w"> </span><span class="n">array_join</span><span class="p">(</span><span class="k">transform</span><span class="p">(</span>
<span class="w">    </span><span class="n">reverse</span><span class="p">(</span><span class="n">array_sort</span><span class="p">(</span><span class="k">transform</span><span class="p">(</span>
<span class="w">      </span><span class="k">transform</span><span class="p">(</span>
<span class="w">        </span><span class="n">map_entries</span><span class="p">(</span><span class="k">input</span><span class="p">),</span>
<span class="w">          </span><span class="n">r</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">row</span><span class="p">(</span><span class="k">key</span><span class="w"> </span><span class="nb">varchar</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="nb">bigint</span><span class="p">))</span>
<span class="w">      </span><span class="p">),</span>
<span class="w">      </span><span class="n">r</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="k">row</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="k">key</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">row</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="nb">varchar</span><span class="p">)))</span>
<span class="w">    </span><span class="p">)),</span>
<span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="k">key</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">freq_separator</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">varchar</span><span class="p">)),</span>
<span class="w">    </span><span class="n">entry_separator</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
</code></pre></div>
</div>
<p>Following is an example query to count generated strings:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><code><span class="k">WITH</span>
<span class="k">data</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">lpad</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">chr</span><span class="p">(</span><span class="mi">65</span><span class="o">+</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">num</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="p">)))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">value</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="k">table</span><span class="p">(</span><span class="n">sequence</span><span class="p">(</span><span class="k">start</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="o">=&gt;</span><span class="mi">10</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="p">),</span>
<span class="n">aggregated</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span>
<span class="w">        </span><span class="n">array_agg</span><span class="p">(</span><span class="k">data</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">all_values</span><span class="p">,</span>
<span class="w">        </span><span class="n">approx_most_frequent</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">top3</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="k">data</span>
<span class="p">)</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">all_values</span><span class="p">,</span>
<span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">top3</span><span class="p">,</span>
<span class="w">    </span><span class="n">format_topn</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">top3</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">top3_formatted</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">aggregated</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
</code></pre></div>
</div>
<p>The preceding query produces the following result:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><code>                     all_values                     |         top3          |    top3_formatted
----------------------------------------------------+-----------------------+---------------------
 [AAA, AAA, BBB, BBB, BBB, CCC, CCC, CCC, DDD, DDD] | {AAA=2, CCC=3, BBB=3} | CCC=3, BBB=3, AAA=2
</code></pre></div>
</div>







  
  






                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../sql.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: SQL user-defined functions">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                SQL user-defined functions
              </div>
            </div>
          </a>
        
        
          
          <a href="begin.html" class="md-footer__link md-footer__link--next" aria-label="Next: BEGIN">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                BEGIN
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  
  
  <div class="md-footer-meta md-typeset">
    
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.action.edit", "content.action.view", "content.code.copy", "content.tabs.link", "content.tooltipsnavigation.expand", "navigation.footer", "navigation.sections", "navigation.top", "navigation.tracking", "search.share", "search.suggest", "toc.integrate", "toc.follow"], "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike", "staticVersions": null, "versionPath": "../versions.json"}}</script>
    
      
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/sphinx_immaterial_theme.32136f45f91ae6956.min.js?v=a7a9472a"></script>
        <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../_static/copybutton.js?v=f281be69"></script>
    
  </body>
</html>